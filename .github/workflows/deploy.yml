# name: Folder Mapper CI

# on:
#   pull_request:
#     branches: [phase-2/develop]

# jobs:    
#   verify-structure:
#     runs-on: ubuntu-latest
    
#     permissions:
#       contents: write
      
#     steps:
#       - name: Checkout PR branch
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0  # Need full history for baseline comparison
#           ref: ${{ github.event.pull_request.head.sha }}

#       - name: Install Bun
#         uses: oven-sh/setup-bun@v1

#       - name: Install dependencies
#         run: bun install

#       - name: Build the project
#         run: bun run build

#       - name: Link the project locally
#         run: bun link

#       - name: Fetch baseline structure from target branch
#         run: |
#           echo "Fetching baseline from ${{ github.base_ref }}..."
#           git fetch origin ${{ github.base_ref }}
            
#           # Try to get old structure.json, create empty if doesn't exist
#           git show origin/${{ github.base_ref }}:docs/structure.json > /tmp/old-structure.json 2>/dev/null || echo "{}" > /tmp/old-structure.json
            
#           if [ -s /tmp/old-structure.json ]; then
#             echo "Baseline found"
#           else
#             echo "No baseline - this is the first structure generation"
#           fi
          
#       - name: Generate structure for PR
#         run: |
#           echo "Generating structure for PR..."
#           folder_mapper run . ./docs

#       - name: Check for structural changes
#         id: diff_check
#         run: |
#           if git diff --quiet docs/structure.json docs/structure.md; then
#             echo "has_changes=false" >> $GITHUB_OUTPUT
#             echo "No structural changes detected"
#           else
#             echo "has_changes=true" >> $GITHUB_OUTPUT
#             echo " Structural changes detected"
#           fi
      
#       - name: Commit structure updates
#         if: steps.diff_check.outputs.has_changes == 'true' && github.event.pull_request.head.repo.full_name == github.repository
#         run: |
#           git config user.name "github-actions[bot]"
#           git config user.email "github-actions[bot]@users.noreply.github.com"
#           git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
#           git add docs/structure.json docs/structure.md
#           git commit -m "chore: auto-update structure docs [skip ci]"
#           git push origin HEAD:${{ github.head_ref }}
#         env:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

#       - name: Success message
#         if: steps.diff_check.outputs.has_changes == 'false'
#         run: |
#           echo "Docs Structure is updated"
#           echo "CI check passed."

# name: Folder Mapper Auto Update

# on:
#   push:
#     branches: [phase-2/develop]

# permissions:
#   contents: write

# jobs:
#   update-structure:
#     runs-on: ubuntu-latest

#     # Prevent infinite loop from bot commits
#     if: "!contains(github.event.head_commit.message, '[skip ci]')"

#     steps:
#       - name: Checkout branch
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0

#       - name: Install Bun
#         uses: oven-sh/setup-bun@v1

#       - name: Install dependencies
#         run: bun install

#       - name: Build the project
#         run: bun run build

#       - name: Link project
#         run: bun link

#       - name: Generate structure
#         run: |
#           echo "Generating structure for branch..."
#           folder_mapper run . ./docs

#       - name: Commit structure updates if changed
#         run: |
#           if git diff --quiet docs/structure.json docs/structure.md; then
#             echo "âœ… No structure changes detected"
#             exit 0
#           fi

#           echo "ðŸ“¦ Structure changed â€” committing updates"

#           git config user.name "github-actions[bot]"
#           git config user.email "github-actions[bot]@users.noreply.github.com"

#           git add docs/structure.json docs/structure.md
#           git commit -m "chore: auto-update structure docs [skip ci]"
#           git push

name: Folder Mapper Auto Update

on:
  push:
    branches: [phase-2/develop]

permissions:
  contents: write

jobs:
  update-structure:
    runs-on: ubuntu-latest

    # Prevent infinite loop from bot commits
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Bun
        uses: oven-sh/setup-bun@v1

      - name: Install dependencies
        run: bun install

      - name: Build the project
        run: bun run build

      - name: Link project
        run: bun link

      - name: Generate structure
        run: |
          echo "Generating structure for branch..."
          bun ./dist/index.js run . ./docs

      - name: Commit structure updates if changed
        run: |
          if git diff --quiet docs/structure.json docs/structure.md; then
            echo "âœ… No structure changes detected"
            exit 0
          fi

          echo "ðŸ“¦ Structure changed â€” committing updates"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/structure.json docs/structure.md
          git commit -m "chore: auto-update structure docs [skip ci]"
          git push
